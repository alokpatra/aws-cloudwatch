---
- hosts: demo
  gather_facts: true
  become: true
  remote_user: ec2-user
  tasks:
  - name: Test ping connections to servers
    ping:
    tags:
      - ping

#Install pre-requisites
  - name: Install prerequistes for Amazon Linux 2
    yum:
      name: "{{ packages }}"
    vars:
      packages:
      - perl-Switch
      - perl-DateTime
      - perl-Sys-Syslog
      - perl-LWP-Protocol-https
      - perl-Digest-SHA.x86_64
      - git

  - name: Clone the repo from github
    git:
      repo: 'https://github.com/alokpatra/aws-cloudwatch.git'
      dest: /home/ec2-user/AWS_Script


# Execute the  perl Script
  - name: This task is to test the execution of the perl script before adding to the cron job.
    shell: ./mon-put-instance-data.pl --mem-util --mem-buffer --mem-cached --mem-used --mem-free --mem-avail
    args:
      chdir: /home/ec2-user/AWS_Script/aws-scripts-mon
    register: result

  - name: Debug the result
    debug:
      var: result

# Set the cron job in root user
  - name: This creates a crob job entry in the root user that runs every 5 minutes
    cron:
      name: "AWS Cloudwatch send metrics"
      minute: "/5"
      job: "/home/ec2-user/AWS_Script/aws-scripts-mon/mon-put-instance-data.pl --mem-util --mem-buffer --mem-cached --mem-used --mem-free --mem-avail --verbose"
